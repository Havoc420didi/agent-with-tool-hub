# 交互式测试工具使用说明

## 概述

本项目提供了两种不同级别的测试工具，用于测试西城咖啡 AI 助手的 Chat API：

1. **快速测试** (`test-quick-chat.mts`) - 简单的单次测试
2. **高级交互式测试** (`test-chat.mts`) - 功能完整的高级交互测试，支持命令简写和工具执行模式切换

## 快速开始

### 1. 启动服务器

首先确保你的 AI 助手服务器正在运行：

```bash
npm run start
# 或者
npm run dev
```

### 2. 运行测试

#### 快速测试
```bash
npm run test:quick
```
- 执行一次简单的对话测试
- 自动显示工具调用结果
- 适合快速验证功能

#### 高级交互式测试
```bash
npm run test:chat
```
- 完整的交互功能
- 流式响应支持
- 会话历史管理
- 配置动态调整
- 命令简写支持
- 工具执行模式切换

## 交互式测试功能

### 命令列表（支持简写）

| 完整命令 | 简写 | 功能 | 说明 |
|---------|------|------|------|
| `/help` | `/h` | 显示帮助 | 查看所有可用命令 |
| `/tools` | `/t` | 工具列表 | 显示所有可用的西城咖啡工具 |
| `/status` | `/s` | 会话状态 | 显示当前会话的统计信息 |
| `/history` | `/hi` | 对话历史 | 查看完整的对话记录 |
| `/config` | `/c` | 当前配置 | 显示模型和参数配置 |
| `/stream` | `/st` | 切换流式 | 在流式/非流式模式间切换 |
| `/mode` | `/m` | 工具执行模式 | 切换工具执行模式 (internal/outside) |
| `/temp <value>` | `/te <value>` | 设置温度 | 调整模型创造性 (0-1) |
| `/model <name>` | `/mo <name>` | 设置模型 | 更换 AI 模型 |
| `/clear` | `/cl` | 清空屏幕 | 清除控制台输出 |
| `/export` | `/e` | 导出历史 | 将对话保存为 JSON 文件 |
| `/reset` | `/r` | 重置会话 | 清空历史，开始新会话 |
| `/exit` | `/ex` | 退出程序 | 结束测试会话 |

### 工具执行模式

支持两种工具执行模式：

- **`internal`** (`i`) - 工具在 AI 内部执行
- **`outside`** (`o`) - 工具在 AI 外部执行

使用 `/mode` 命令切换模式：
```bash
/mode i    # 切换到内部模式
/mode o    # 切换到外部模式
/mode      # 显示当前模式和可用选项
```

## 使用示例

### 1. 基础对话测试

```bash
npm run test:chat
```

```
你: 推荐一些咖啡
🤖 AI助手: 我来为您推荐一些美味的咖啡...

你: 看一下我的购物车
🤖 AI助手: 让我查看一下您的购物车...
```

### 2. 高级功能测试

```
你: /c
⚙️ 当前配置:
  模型: deepseek-chat
  温度: 0
  流式: 否
  工具执行模式: outside
  API地址: http://localhost:3000

你: /st
✅ 已切换到流式模式

你: /m i
✅ 工具执行模式已切换为: internal

你: 推荐一些咖啡
🤖 AI助手: 我来为您推荐一些美味的咖啡...
```

### 3. 工具调用测试

```
你: 我要一杯冰美式
🤖 AI助手: 好的，我来为您点一杯冰美式...

🔧 工具调用:
  1. displayGoods
     参数: {"goodsList": [...]}
     结果: {"message": "商品展示成功", ...}
```

### 4. 命令简写使用

```
你: /h
📋 可用命令:
  /help (/h)        - 显示帮助信息
  /tools (/t)       - 显示可用工具列表
  ...

你: /m
🔧 当前工具执行模式: outside
可用模式:
  internal (i) - 工具在AI内部执行
  outside (o)  - 工具在AI外部执行
用法: /mode <internal|outside|i|o>

你: /m i
✅ 工具执行模式已切换为: internal
```

## 配置说明

### 环境变量

确保在 `config.env` 文件中配置了必要的环境变量：

```env
API_BASE_URL=http://localhost:3000
OPENAI_BASE_URL=your_openai_base_url
OPENAI_API_KEY=your_openai_api_key
```

### 模型配置

支持通过命令动态调整模型参数：

- **温度值** (0-1): 控制回复的创造性
- **模型名称**: 支持不同的 AI 模型
- **流式模式**: 实时显示 AI 回复过程
- **工具执行模式**: 控制工具在 AI 内部或外部执行

## 故障排除

### 常见问题

1. **连接失败**
   ```
   ❌ 请求失败: fetch failed
   ```
   - 检查服务器是否正在运行
   - 确认 API_BASE_URL 配置正确

2. **工具调用失败**
   ```
   ❌ AI回复失败: Tool execution failed
   ```
   - 检查工具配置
   - 查看服务器日志

3. **流式响应异常**
   ```
   ❌ 流式响应解析失败
   ```
   - 确认服务器支持流式响应
   - 检查网络连接稳定性

### 调试技巧

1. **查看详细日志**
   ```bash
   DEBUG=* npm run test:chat
   ```

2. **导出对话历史**
   ```
   你: /e
   ✅ 对话历史已导出到 chat-export-session_xxx.json
   ```

3. **重置会话状态**
   ```
   你: /r
   ✅ 会话已重置
   ```

4. **命令简写冲突处理**
   ```
   你: /s
   ❌ 命令简写冲突: /s
   可能的命令:
     /s -> /status
     /st -> /stream
   请使用更具体的简写
   ```

## 开发说明

### 文件结构

```
tests/
├── test-quick-chat.mts      # 快速测试
├── test-chat.mts            # 高级交互式测试
└── INTERACTIVE_TEST_README.md # 使用说明
```

### 扩展功能

如需添加新的测试功能，可以：

1. 在相应的测试类中添加新方法
2. 更新命令处理逻辑
3. 添加新的配置选项
4. 更新帮助文档

### 自定义工具

测试工具会自动加载 `WestoreCafeTools` 中的所有工具，如需测试其他工具：

1. 修改工具导入
2. 更新工具列表显示
3. 调整工具调用处理逻辑

## 许可证

本项目遵循 MIT 许可证。
