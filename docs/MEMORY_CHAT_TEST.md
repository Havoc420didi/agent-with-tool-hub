# 记忆功能聊天测试指南

## 概述

本文档介绍如何使用适配后的 `test-chat.mts` 来测试两种记忆模式：API模式和LG模式。

## 功能特性

### 新增功能
- ✅ 支持两种记忆模式：`api` 和 `lg`
- ✅ 动态切换记忆模式
- ✅ 记忆功能测试命令
- ✅ 显示记忆模式状态
- ✅ 自动适配不同模式的请求格式

### 记忆模式对比

| 特性 | API模式 | LG模式 |
|------|---------|--------|
| 历史管理 | 客户端控制 | 服务端自动管理 |
| 网络开销 | 较大（每次传递完整历史） | 较小（只传递thread_id） |
| 会话隔离 | 基于客户端逻辑 | 基于thread_id |
| 跨会话支持 | 支持 | 需要手动管理 |
| 实现复杂度 | 简单 | 复杂 |

## 使用方法

### 启动测试

```bash
# 启动服务器
npm run dev

# 在另一个终端运行测试
npx tsx tests/test-chat.mts
```

### 可用命令

#### 基本命令
- `/help` - 显示帮助信息
- `/status` - 显示会话状态
- `/config` - 显示当前配置
- `/history` - 显示对话历史

#### 记忆相关命令
- `/memory` - 切换记忆模式（api/lg）
- `/test-memory` - 测试记忆功能
- `/reset` - 重置会话

#### 其他命令
- `/mode` - 切换工具执行模式
- `/stream` - 切换流式/非流式模式
- `/temp <value>` - 设置温度值
- `/model <name>` - 设置模型名称

### 测试步骤

#### 1. 测试LG模式（默认）

```bash
# 启动测试
npx tsx tests/test-chat.mts

# 发送消息
你: 你好，我叫张三
AI: 你好张三！很高兴认识你...

# 测试记忆
你: 你还记得我的名字吗？
AI: 当然记得，你刚才告诉我你叫张三...

# 查看记忆模式
你: /memory
# 显示当前记忆模式为 lg
```

#### 2. 测试API模式

```bash
# 切换到API模式
你: /memory api
# 显示：记忆模式已切换为: api

# 发送消息
你: 你好，我叫李四
AI: 你好李四！很高兴认识你...

# 测试记忆
你: 你还记得我的名字吗？
AI: 当然记得，你刚才告诉我你叫李四...
```

#### 3. 测试记忆功能

```bash
# 运行记忆测试
你: /test-memory
# 显示当前记忆模式状态和测试建议
```

## 技术实现

### API模式实现

```typescript
// 请求格式
{
  message: "用户消息",
  threadId: "session_123",
  memoryMode: "api",
  memory: { enabled: true, mode: "api", maxHistory: 50 },
  chatHistory: [
    { type: "human", content: "历史消息", timestamp: "2024-01-01T00:00:00Z" },
    { type: "ai", content: "AI回复", timestamp: "2024-01-01T00:00:01Z" }
  ]
}
```

### LG模式实现

```typescript
// 请求格式
{
  message: "用户消息",
  threadId: "session_123",
  memoryMode: "lg",
  memory: { enabled: true, mode: "lg", maxHistory: 50 }
  // 不需要传递chatHistory，服务端自动管理
}
```

## 测试脚本

### 自动化测试

```bash
# 运行自动化记忆测试
npx tsx tests/test-memory-chat.mts
```

该脚本会：
1. 测试LG模式的记忆功能
2. 测试API模式的记忆功能
3. 测试记忆模式切换
4. 显示测试结果总结

### 测试结果示例

```
🧠 测试记忆功能的聊天...

🔵 测试LG模式（服务端自动管理历史）
==================================================
👤 用户: 你好，我叫张三
🤖 AI: 你好张三！很高兴认识你...
记忆模式: lg

👤 用户: 你还记得我的名字吗？
🤖 AI: 当然记得，你刚才告诉我你叫张三...
记忆模式: lg

🟢 测试API模式（客户端控制历史）
==================================================
👤 用户: 你好，我叫李四
🤖 AI: 你好李四！很高兴认识你...
记忆模式: api

👤 用户: 你还记得我的名字吗？
🤖 AI: 当然记得，你刚才告诉我你叫李四...
记忆模式: api

✅ 记忆功能测试完成！

📊 测试结果总结:
- LG模式: ✅ 记住
- API模式: ✅ 记住
```

## 故障排除

### 常见问题

1. **记忆不工作**
   - 检查记忆模式设置：`/memory`
   - 确认thread_id是否一致
   - 检查服务端日志

2. **API模式历史丢失**
   - 确认chatHistory格式正确
   - 检查maxHistory设置
   - 验证客户端历史管理逻辑

3. **LG模式历史丢失**
   - 确认thread_id一致
   - 检查服务端checkpointer配置
   - 验证LangGraph状态管理

### 调试命令

```bash
# 查看当前配置
/status

# 查看记忆模式
/memory

# 测试记忆功能
/test-memory

# 查看对话历史
/history
```

## 最佳实践

1. **选择记忆模式**
   - 简单应用：使用LG模式
   - 复杂历史管理：使用API模式
   - 跨会话需求：使用API模式

2. **性能优化**
   - LG模式：减少网络传输
   - API模式：控制历史记录大小
   - 合理设置maxHistory

3. **错误处理**
   - 实现重试机制
   - 处理网络异常
   - 验证响应格式

## 总结

适配后的 `test-chat.mts` 提供了完整的记忆功能测试能力，支持两种记忆模式的动态切换和测试。通过交互式命令和自动化测试脚本，可以全面验证记忆功能的正确性和性能。
